version: '3.9'
services:
  im-gateway:
    build:
      context: ./im-gateway/src/main/resources
      dockerfile: Dockerfile
      # 添加此配置确保使用本地镜像
      cache_from:
        - openjdk:17-jdk
    image: im-gateway:latest

    hostname: im-gateway
    container_name: im-gateway
    restart: always
    ports:
      - "8081:8081"
    networks:
      - default_network
    volumes:
      - "/tmp/data/logs:/logs"
    environment:
      # JDK 17 兼容性配置
      - JAVA_OPTS=--add-opens java.base/java.nio=ALL-UNNAMED --add-opens java.base/sun.nio.ch=ALL-UNNAMED --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.lang.reflect=ALL-UNNAMED --add-opens java.base/jdk.internal.misc=ALL-UNNAMED --add-opens java.base/java.time=ALL-UNNAMED
  im-auth:
    build:
      context: ./im-auth/src/main/resources
      dockerfile: Dockerfile
      # 添加此配置确保使用本地镜像
      cache_from:
        - openjdk:17-jdk
    image: im-auth:latest

    hostname: im-auth
    container_name: im-auth
    restart: always
    ports:
      - "8082:8082"
    networks:
      - default_network
    volumes:
      - "/tmp/data/logs:/logs"
    environment:
      # JDK 17 兼容性配置 - OAuth2/JAXB 反射访问
      - JAVA_OPTS=--add-opens java.base/java.nio=ALL-UNNAMED --add-opens java.base/sun.nio.ch=ALL-UNNAMED --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.lang.reflect=ALL-UNNAMED --add-opens java.base/jdk.internal.misc=ALL-UNNAMED --add-opens java.base/java.time=ALL-UNNAMED --add-opens java.base/java.security=ALL-UNNAMED --add-opens java.xml/com.sun.org.apache.xerces.internal.jaxp=ALL-UNNAMED --add-opens java.xml/javax.xml.bind=ALL-UNNAMED --add-opens java.xml/com.sun.xml.bind=ALL-UNNAMED --add-opens java.xml/com.sun.xml.bind.v2=ALL-UNNAMED --add-opens java.xml/com.sun.xml.bind.v2.runtime=ALL-UNNAMED --add-opens java.xml/com.sun.xml.bind.v2.runtime.reflect=ALL-UNNAMED --add-opens java.xml/com.sun.xml.bind.v2.runtime.reflect.opt=ALL-UNNAMED
  im-business:
    # 可以根据Dockerfile构建镜像（但是，Docker Compose 会在检测到上下文变化时重新构建镜像。也就是说如果你不修改Dockerfile docker-compose应该不是每次都构建镜像 实测确实如此）
    build:
      context: ./im-business/im-business-service/src/main/resources # 指定Dockerfile文件位置
      dockerfile: Dockerfile # 指定名称
      # 添加此配置确保使用本地镜像
      cache_from:
        - openjdk:17-jdk
    image: im-business:latest # 指定生成镜像的 名称

    # 也可以直接指定镜像名 但是要确保镜像存在 （如果在docker仓库, 则不需要再本地存在镜像 会自动pull）
    # image: im-business:0.0.2

    # 设置容器的主机名 即修改 ： /etc/hosts 中的内容,注意 如果是在docker中 ，容器间相互访问的时使用的是 容器的hostname 那么必须配hostname
    hostname: im-business
    # 容器名称
    container_name: im-business
    # 重启策略， always 表示无论哪种状态退出，都会重启容器
    restart: always
    ports:
      # 设置主机与容器的端口映射
      - "8083:8083"
    networks:
      # 使用默认网络即：docker0 桥接
      - default_network
    extra_hosts:
      - "hadoop01:192.168.1.130"
      - "hadoop02:192.168.1.131"
      - "hadoop03:192.168.1.132"
    volumes:
      # 将主机的 /tmp/data/logs 目录挂载到容器的 /logs 目录。这样可以实现数据的持久化，当容器重启时，数据不会丢失，注意 挂载文件需要给宿主机文件 添加最权限，chmod -R 777 目标文件夹
      - "/tmp/data/logs:/logs"
    environment:
      # JDK 17 兼容性配置 - HBase/JAXB 反射访问
      - JAVA_OPTS=--add-opens java.base/java.nio=ALL-UNNAMED --add-opens java.base/sun.nio.ch=ALL-UNNAMED --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.lang.reflect=ALL-UNNAMED --add-opens java.xml/com.sun.org.apache.xerces.internal.jaxp=ALL-UNNAMED --add-opens java.base/jdk.internal.misc=ALL-UNNAMED --add-opens java.base/java.time=ALL-UNNAMED

  im-connect:
    build:
      context: ./im-connect/im-connect-service/src/main/resources
      dockerfile: Dockerfile
      # 添加此配置确保使用本地镜像
      cache_from:
        - openjdk:17-jdk
    image: im-connect:latest
    hostname: im-connect
    container_name: im-connect
    restart: always
    ports:
      - "10000:10000" # prometheus指标采集端口 http (注：不采用jmx方式采集)
      - "10001:10001" # netty端口
    networks:
      - default_network
    volumes:
      - "/tmp/data/logs:/logs"
    # ==================== 百万连接关键配置 ====================
    # 文件句柄限制（必须！默认1024根本不够）
    ulimits:
      nofile:
        soft: 1000000
        hard: 1000000
      nproc:
        soft: 65535
        hard: 65535
    # 内核参数优化 - 仅设置容器级别允许的参数
    # 注意：以下参数必须在宿主机设置（通过 optimize-system.sh）：
    #   - net.core.rmem_max/wmem_max
    #   - net.core.rmem_default/wmem_default
    #   - net.ipv4.tcp_rmem/tcp_wmem
    #   - net.ipv4.tcp_slow_start_after_idle
    sysctls:
      # 连接队列（Docker 白名单内）
      - net.core.somaxconn=65535
      - net.ipv4.tcp_max_syn_backlog=65535
      - net.core.netdev_max_backlog=65535
      # TCP 连接优化（Docker 白名单内）
      - net.ipv4.ip_local_port_range=1024 65535
      - net.ipv4.tcp_tw_reuse=1
      - net.ipv4.tcp_fin_timeout=10
      - net.ipv4.tcp_keepalive_time=600
      - net.ipv4.tcp_keepalive_intvl=30
      - net.ipv4.tcp_keepalive_probes=3
    # 内存限制（根据服务器配置调整）
    # 推荐配置：堆内存+直接内存+系统开销 = 8g + 4g + 2g = 14g
    deploy:
      resources:
        limits:
          cpus: '16'
          memory: 12G
        reservations:
          cpus: '4'
          memory: 6G
    # =========================================================
    environment:
      # JVM 高性能参数（百万连接 + 高QPS 优化）
      # 内存：堆4G + 直接内存2G（Netty零拷贝）
      # GC：ZGC低延迟（<1ms停顿）
      # 吞吐优化：JIT编译优化 + 大页内存 + 偏向锁禁用
      - JAVA_OPTS=-Xms4g -Xmx4g -XX:MaxDirectMemorySize=2g -XX:+UseZGC -XX:+ZGenerational -Xss512k -XX:+AlwaysPreTouch -XX:-UseBiasedLocking -XX:+UseStringDeduplication -XX:ConcGCThreads=4 -XX:ParallelGCThreads=8 -XX:+PerfDisableSharedMem -Djdk.nio.maxCachedBufferSize=262144 -Dio.netty.leakDetection.level=disabled -Dio.netty.allocator.type=pooled -Dio.netty.allocator.numHeapArenas=16 -Dio.netty.allocator.numDirectArenas=16 -Dio.netty.recycler.maxCapacityPerThread=4096 -Dio.netty.eventLoopThreads=0

  im-console:
    build:
      context: ./im-console/im-console-service/src/main/resources
      dockerfile: Dockerfile
      # 添加此配置确保使用本地镜像
      cache_from:
        - openjdk:17-jdk
    image: im-console:latest
    hostname: im-console
    container_name: im-console
    restart: always
    ports:
      - "8084:8084"
    networks:
      - default_network
    volumes:
      - "/tmp/data/logs:/logs"
    environment:
      # JDK 17 兼容性配置
      - JAVA_OPTS=--add-opens java.base/java.nio=ALL-UNNAMED --add-opens java.base/sun.nio.ch=ALL-UNNAMED --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.lang.reflect=ALL-UNNAMED --add-opens java.base/jdk.internal.misc=ALL-UNNAMED --add-opens java.base/java.time=ALL-UNNAMED


  im-data-sync:
    build:
      context: ./im-data-sync/src/main/resources
      dockerfile: Dockerfile
      # 添加此配置确保使用本地镜像
      cache_from:
        - openjdk:17-jdk
    image: im-data-sync:latest
    hostname: im-data-sync
    container_name: im-data-sync
    restart: always
    ports:
      - "8085:8085"
    networks:
      - default_network
    volumes:
      - "/tmp/data/logs:/logs"
    environment:
      # JDK 17 兼容性配置
      - JAVA_OPTS=--add-opens java.base/java.nio=ALL-UNNAMED --add-opens java.base/sun.nio.ch=ALL-UNNAMED --add-opens java.base/java.lang=ALL-UNNAMED --add-opens java.base/java.lang.reflect=ALL-UNNAMED --add-opens java.base/jdk.internal.misc=ALL-UNNAMED --add-opens java.base/java.time=ALL-UNNAMED

networks:
  default_network:
    # 使用docker默认网络即：（桥接模式）
    driver: bridge

