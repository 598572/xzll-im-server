# ===================================================================
# Netty 心跳配置（用于配置中心 Nacos）
# ===================================================================
# 服务：im-connect
# Data ID: im-connect-heartbeat.yml
# Group: DEFAULT_GROUP
# ===================================================================

im:
  netty:
    # ============================================================
    # 心跳超时时间（秒）- 建议值：30秒
    # ============================================================
    # 说明：
    # - 客户端需要在这个时间内发送心跳，否则连接会被标记为超时
    # - 如果连续超时达到 maxHeartbeatFailures 次，服务端会关闭连接
    # 
    # 调优建议：
    # - 网络稳定环境：30-60秒
    # - 不稳定环境：15-30秒
    # - 实时性要求高：10-15秒
    # 
    # 注意事项：
    # - 不建议设置过小（<10秒），会增加服务器负担
    # - 不建议设置过大（>120秒），客户端断线检测会很慢
    # ============================================================
    heartBeatTime: 30
    
    # ============================================================
    # 最大心跳失败次数 - 建议值：3次
    # ============================================================
    # 说明：
    # - 连续心跳超时达到这个次数后，服务端会主动关闭连接
    # - 总超时时间 = heartBeatTime × maxHeartbeatFailures
    # 
    # 计算示例：
    # - heartBeatTime: 30秒, maxHeartbeatFailures: 3
    #   → 客户端断网后，90秒内会被服务端踢下线
    # 
    # 调优建议：
    # - 网络稳定环境：2-3次（快速检测断线）
    # - 不稳定环境：3-5次（避免误踢）
    # ============================================================
    maxHeartbeatFailures: 3
    
    # ============================================================
    # 主动心跳发送间隔（秒）- 建议值：25秒
    # ============================================================
    # 说明：
    # - 服务端主动向客户端发送 Ping 的间隔
    # - 用于检测连接是否仍然活跃（双向心跳）
    # 
    # 调优建议：
    # - 应该小于 heartBeatTime（建议为 heartBeatTime - 5秒）
    # - 例如：heartBeatTime=30，则 activeHeartbeatInterval=25
    # 
    # 工作原理：
    # - 客户端发送心跳 → 更新 lastReadTime
    # - 服务端主动 Ping → 客户端回复 Pong → 更新 lastReadTime
    # - 如果客户端长时间不发送心跳，服务端会主动发送 Ping
    # ============================================================
    activeHeartbeatInterval: 25

# ===================================================================
# 不同场景的推荐配置
# ===================================================================

# -----------------------------------------------------
# 场景1：生产环境（标准配置）- 平衡稳定性和实时性
# -----------------------------------------------------
# im.netty.heartBeatTime: 30
# im.netty.maxHeartbeatFailures: 3
# im.netty.activeHeartbeatInterval: 25
# 
# 特点：
# - 客户端断网后 90秒内被踢下线
# - 网络抖动有 3次 容错机会
# - 适合大多数应用场景

# -----------------------------------------------------
# 场景2：实时性要求高（快速检测断线）
# -----------------------------------------------------
# im.netty.heartBeatTime: 15
# im.netty.maxHeartbeatFailures: 2
# im.netty.activeHeartbeatInterval: 10
# 
# 特点：
# - 客户端断网后 30秒内被踢下线
# - 快速响应，但网络抖动容错率低
# - 适合游戏、在线会议等实时场景

# -----------------------------------------------------
# 场景3：弱网环境（高容错）
# -----------------------------------------------------
# im.netty.heartBeatTime: 45
# im.netty.maxHeartbeatFailures: 5
# im.netty.activeHeartbeatInterval: 40
# 
# 特点：
# - 客户端断网后 225秒（约3.75分钟）才被踢下线
# - 网络抖动容错率高，但断线检测慢
# - 适合农村、地铁等网络不稳定场景

# -----------------------------------------------------
# 场景4：开发/测试环境（极短检测）
# -----------------------------------------------------
# im.netty.heartBeatTime: 10
# im.netty.maxHeartbeatFailures: 2
# im.netty.activeHeartbeatInterval: 5
# 
# 特点：
# - 客户端断网后 20秒内被踢下线
# - 便于快速测试断线重连逻辑
# - 不建议在生产环境使用

# ===================================================================
# 客户端配置建议（与服务端配套）
# ===================================================================
# 
# Flutter/Java客户端应该配置：
# - 心跳发送间隔：应 < 服务端 heartBeatTime
#   例如：服务端 30秒，客户端应每 25秒 发送一次心跳
# 
# - 心跳超时检测：应 略大于 服务端 heartBeatTime
#   例如：服务端 30秒，客户端超时检测设为 35-40秒
# 
# - 重连策略：
#   - 第1次重连：立即
#   - 第2次重连：2秒后
#   - 第3次重连：5秒后
#   - 后续重连：10秒间隔

# ===================================================================
# 监控和告警建议
# ===================================================================
# 
# 1. 监控指标：
#    - 心跳超时次数：如果频繁超时，可能是网络问题或服务器负载过高
#    - 连接关闭次数：异常关闭率高，需要检查配置或网络
#    - 活跃连接数：突然下降可能是心跳配置过于严格
# 
# 2. 告警规则：
#    - 心跳超时率 > 10%：警告级别
#    - 心跳超时率 > 30%：严重级别
#    - 连接异常关闭率 > 5%：警告级别

# ===================================================================
# 配置更新说明
# ===================================================================
# 
# 1. 配置生效：
#    - 使用 @RefreshScope 注解，配置更新后无需重启服务
#    - 更新后对新建连接生效，现有连接继续使用旧配置
# 
# 2. 动态调整：
#    - 可以在 Nacos 控制台实时调整配置
#    - 建议在低峰期调整心跳参数
# 
# 3. 回滚策略：
#    - Nacos 支持配置版本管理
#    - 如果调整后出现问题，可以快速回滚到上一个版本

# ===================================================================
# 常见问题 FAQ
# ===================================================================
# 
# Q1: 为什么客户端断网后服务端没有立即踢下线？
# A1: 因为心跳检测需要时间，总时间 = heartBeatTime × maxHeartbeatFailures
#     例如：30秒 × 3次 = 90秒后才会踢下线
# 
# Q2: 如何加快断线检测速度？
# A2: 减小 heartBeatTime 或 maxHeartbeatFailures，但要注意：
#     - 太小会增加服务器负担
#     - 网络抖动时容易误踢
# 
# Q3: 客户端需要做什么配置？
# A3: 客户端心跳间隔应 < 服务端 heartBeatTime
#     例如：服务端30秒，客户端25秒发送一次心跳
# 
# Q4: 配置修改后需要重启吗？
# A4: 不需要，使用了 @RefreshScope，配置会动态刷新
#     但只对新建连接生效，现有连接保持旧配置
# 
# Q5: 如何验证配置是否生效？
# A5: 查看日志：
#     - "心跳检测正常" 日志中会显示当前配置
#     - "心跳超时检测" 日志中会显示失败次数/最大次数

# ===================================================================
# 配置示例（完整配置参考）
# ===================================================================
# 
# 如果需要同时配置其他 Netty 参数，可以使用：
# 
# im:
#   netty:
#     nettyPort: 9001
#     prometheusPort: 9002
#     soBackLog: 1024
#     debug: false
#     heartBeatTime: 30
#     maxHeartbeatFailures: 3
#     activeHeartbeatInterval: 25

