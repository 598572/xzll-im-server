
# IMç³»ç»Ÿ - å•æœåŠ¡å™¨ä¸€è‡´æ€§å“ˆå¸Œé…ç½® + åå°ç®¡ç†ç³»ç»Ÿ
# å½“å‰é…ç½®ï¼š
#   - APPç«¯ï¼š8090ç«¯å£ï¼ˆim-gateway + im-connect WebSocketï¼‰
#   - ç®¡ç†ç«¯ï¼š8092ç«¯å£ï¼ˆim-consoleåå°ç®¡ç†ï¼‰
user root;
worker_processes auto;
error_log /home/hzz/nginx/logs/error.log;
pid /home/hzz/nginx/logs/nginx.pid;

# äº‹ä»¶æ¨¡å— - IMåœºæ™¯ä¼˜åŒ–
events {
    worker_connections 8192;      # IMç³»ç»Ÿéœ€è¦æ”¯æŒå¤§é‡é•¿è¿æ¥
    use epoll;                    # Linuxä¸‹ä½¿ç”¨epollï¼Œé«˜æ•ˆå¤„ç†å¤§é‡è¿æ¥
    multi_accept on;              # ä¸€æ¬¡æ¥å—å¤šä¸ªè¿æ¥ï¼Œæå‡æ€§èƒ½
    accept_mutex off;             # å…³é—­äº’æ–¥é”ï¼Œé¿å…æƒŠç¾¤é—®é¢˜
}

# HTTP æ¨¡å—
http {
    # åŸºç¡€é…ç½®
    include /home/hzz/nginx/conf/mime.types;
    default_type application/octet-stream;

    # æ—¥å¿—æ ¼å¼ - å¢å¼ºç‰ˆï¼Œå¢åŠ upstreamå’ŒuserIdä¿¡æ¯ä¾¿äºè°ƒè¯•
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'upstream_addr="$upstream_addr" '
                    'upstream_status="$upstream_status" '
                    'request_time=$request_time '
                    'userId="$arg_userId"';

    # ç®¡ç†åå°ä¸“ç”¨æ—¥å¿—æ ¼å¼ - åŒ…å«ç®¡ç†å‘˜ä¿¡æ¯
    log_format admin_log '$remote_addr - $remote_user [$time_local] "$request" '
                         '$status $body_bytes_sent "$http_referer" '
                         '"$http_user_agent" "$http_x_forwarded_for" '
                         'admin_id="$http_x_admin_id" '
                         'request_time=$request_time '
                         'upstream_addr="$upstream_addr" '
                         'upstream_status="$upstream_status"';

    # IMåœºæ™¯æ€§èƒ½ä¼˜åŒ–
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;               # å¯¹IMå®æ—¶æ€§å¾ˆé‡è¦ï¼Œç¦ç”¨Nagleç®—æ³•
    keepalive_timeout 300;        # IMåœºæ™¯å»¶é•¿keepaliveæ—¶é—´åˆ°5åˆ†é’Ÿ
    keepalive_requests 10000;     # å¢åŠ å•ä¸ªè¿æ¥å¯å¤„ç†çš„è¯·æ±‚æ•°
    types_hash_max_size 2048;
    client_max_body_size 100M;

    # IMåœºæ™¯ç‰¹æ®Šä¼˜åŒ–
    proxy_connect_timeout 10s;    # ä»£ç†è¿æ¥è¶…æ—¶
    proxy_send_timeout 300s;      # ä»£ç†å‘é€è¶…æ—¶ï¼Œé€‚åº”IMé•¿è¿æ¥
    proxy_read_timeout 300s;      # ä»£ç†è¯»å–è¶…æ—¶ï¼Œé€‚åº”IMé•¿è¿æ¥
    send_timeout 300s;            # å‘é€è¶…æ—¶

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # ==================== ã€æ–°å¢ã€‘ç®¡ç†åå°è¯·æ±‚é™æµé…ç½® ====================
    # é˜²æ­¢æ¶æ„è¯·æ±‚ï¼Œä¿æŠ¤ç®¡ç†åå°å®‰å…¨
    limit_req_zone $binary_remote_addr zone=admin_api_limit:10m rate=20r/s;
    limit_conn_zone $binary_remote_addr zone=admin_conn_limit:10m;

    # ==================== ã€æ–°å¢ã€‘CORS é…ç½® Map ====================
    # ç”¨äºä¼˜é›…åœ°å¤„ç†è·¨åŸŸè¯·æ±‚ï¼Œæ”¯æŒ Flutter Web ç­‰æµè§ˆå™¨å®¢æˆ·ç«¯
    map $request_method $cors_method {
        OPTIONS 11;    # é¢„æ£€è¯·æ±‚
        GET     10;    # æ™®é€šGETè¯·æ±‚
        POST    10;    # æ™®é€šPOSTè¯·æ±‚
        PUT     10;    # æ™®é€šPUTè¯·æ±‚
        DELETE  10;    # æ™®é€šDELETEè¯·æ±‚
        default 0;     # å…¶ä»–è¯·æ±‚ä¸å¤„ç†CORS
    }

    # ==================== ä¸Šæ¸¸æœåŠ¡å™¨ç»„å®šä¹‰ ====================

    # ç½‘å…³æœåŠ¡å™¨ç»„ - å¤„ç†HTTP APIè¯·æ±‚
    upstream im_gateway_backend {
        # ç½‘å…³æœåŠ¡å™¨åœ°å€ - 8081ç«¯å£
        server 192.168.1.150:8081;
        # æœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šç½‘å…³å®ä¾‹ï¼š
        # server 192.168.1.151:8081;
        # server 192.168.1.152:8081;

        # ç½‘å…³è¿æ¥æ± ä¼˜åŒ–
        keepalive 32;                     # ç½‘å…³è¿æ¥æ± 
        keepalive_requests 1000;          # ç½‘å…³è¯·æ±‚æ•°é™åˆ¶
        keepalive_timeout 60s;            # ç½‘å…³è¿æ¥è¶…æ—¶
    }

    # ã€é‡ç‚¹ã€‘im-connect WebSocketæœåŠ¡å™¨ç»„ - å•æœåŠ¡å™¨ä¸€è‡´æ€§å“ˆå¸Œ
    upstream im_server_backend {
        # ğŸ¯ å½“å‰åªæœ‰ä¸€ä¸ªim-connectå®ä¾‹
        server 192.168.1.150:10001 weight=1 max_fails=3 fail_timeout=30s;

        # ğŸ“ˆ æœªæ¥æ‰©å±•æ—¶å–æ¶ˆæ³¨é‡Šä»¥ä¸‹é…ç½®ï¼š
        # server 192.168.1.151:10001 weight=1 max_fails=3 fail_timeout=30s;
        # server 192.168.1.152:10001 weight=1 max_fails=3 fail_timeout=30s;
        # server 192.168.1.153:10001 weight=1 max_fails=3 fail_timeout=30s;

        # ã€å…³é”®é…ç½®ã€‘åŸºäºuserIdå‚æ•°çš„ä¸€è‡´æ€§å“ˆå¸Œ
        # å³ä½¿åªæœ‰ä¸€ä¸ªæœåŠ¡å™¨ï¼Œä¹Ÿä¿ç•™æ­¤é…ç½®ï¼Œä¾¿äºå°†æ¥æ°´å¹³æ‰©å±•
        # å½“WebSocketè¿æ¥æ—¶ï¼ŒURLæ ¼å¼ä¸º: ws://domain/websocket?userId=123456
        hash $arg_userId consistent;

        # å•æœåŠ¡å™¨åœºæ™¯è¿æ¥æ± ä¼˜åŒ–
        keepalive 64;                     # å•æœåŠ¡å™¨é€‚ä¸­çš„è¿æ¥æ± å¤§å°
        keepalive_requests 10000;         # å•ä¸ªkeepaliveè¿æ¥å¤„ç†æ›´å¤šè¯·æ±‚
        keepalive_timeout 300s;           # keepaliveè¿æ¥è¶…æ—¶æ—¶é—´
    }

    # ==================== ã€æ–°å¢ã€‘IM Consoleåå°ç®¡ç†ç³»ç»Ÿ ====================
    # åå°ç®¡ç†æœåŠ¡å™¨ç»„
    upstream im_console_backend {
        server 192.168.1.150:8084 max_fails=3 fail_timeout=30s;

        # å°†æ¥å¯ä»¥æ·»åŠ æ›´å¤šå®ä¾‹å®ç°è´Ÿè½½å‡è¡¡ï¼š
        # server 192.168.1.151:8084 max_fails=3 fail_timeout=30s;

        # ç®¡ç†åå°è¿æ¥æ± ä¼˜åŒ–
        keepalive 16;
        keepalive_requests 500;
        keepalive_timeout 60s;
    }

    # ==================== æœåŠ¡å™¨é…ç½® ====================

    # ==================== ã€åŸæœ‰ã€‘APPç«¯æœåŠ¡å™¨é…ç½® ====================
    server {
        listen 8090;
        server_name 47.93.209.60;  # ä½ çš„å…¬ç½‘ IP

        # æ—¥å¿—é…ç½®
        access_log /home/hzz/nginx/logs/im_access.log main;
        error_log  /home/hzz/nginx/logs/im_error.log;

        # ==================== HTTP APIæ¥å£ä»£ç†åˆ°ç½‘å…³ ====================

        # è®¤è¯æœåŠ¡æ¥å£ä»£ç†
        location /im-auth/ {

            # âœ… ã€æ–°å¢ã€‘å¤„ç†CORSé¢„æ£€è¯·æ±‚ï¼ˆOPTIONSï¼‰
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '$http_origin' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,...' always;
                add_header 'Access-Control-Max-Age' '86400' always;  # 24å°æ—¶ç¼“å­˜
                return 204;
            }

            # âœ… ã€æ–°å¢ã€‘ä¸ºå®é™…è¯·æ±‚æ·»åŠ CORSå“åº”å¤´
            add_header 'Access-Control-Allow-Origin' '$http_origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range,Authorization' always;


            proxy_pass http://im_gateway_backend/im-auth/;

            # åŸºç¡€ä»£ç†å¤´è®¾ç½®
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;

            # HTTP/1.1 æ”¯æŒ
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # è¶…æ—¶é…ç½®
            proxy_connect_timeout 30s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;

            # ç¼“å†²é…ç½®
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;

            # é”™è¯¯å¤„ç†
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        }

        # ä¸šåŠ¡æœåŠ¡æ¥å£ä»£ç†
        location /im-business/ {

            # âœ… ã€æ–°å¢ã€‘å¤„ç†CORSé¢„æ£€è¯·æ±‚ï¼ˆOPTIONSï¼‰
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '$http_origin' always;
                add_header 'Access-Control-Allow-Credentials' 'true' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,...' always;
                add_header 'Access-Control-Max-Age' '86400' always;  # 24å°æ—¶ç¼“å­˜
                return 204;
            }

            # âœ… ã€æ–°å¢ã€‘ä¸ºå®é™…è¯·æ±‚æ·»åŠ CORSå“åº”å¤´
            add_header 'Access-Control-Allow-Origin' '$http_origin' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range,Authorization' always;


            proxy_pass http://im_gateway_backend/im-business/;

            # åŸºç¡€ä»£ç†å¤´è®¾ç½®
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;

            # HTTP/1.1 æ”¯æŒ
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # è¶…æ—¶é…ç½®
            proxy_connect_timeout 30s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;

            # ç¼“å†²é…ç½®
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;

            # é”™è¯¯å¤„ç†
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        }

        # ==================== ã€æ ¸å¿ƒã€‘WebSocketé•¿è¿æ¥ä»£ç† - userIdä¸€è‡´æ€§å“ˆå¸Œ ====================

        # WebSocket é•¿è¿æ¥è·¯ç”± - åŸºäºuserIdå“ˆå¸Œï¼ˆå•æœåŠ¡å™¨é…ç½®ï¼‰
        location /websocket {
            # ã€é‡è¦ã€‘æ£€æŸ¥userIdå‚æ•°æ˜¯å¦å­˜åœ¨
            if ($arg_userId = "") {
                return 400 "userId parameter is required";
            }

            # åå‘ä»£ç†åˆ°im-connectæœåŠ¡å™¨ï¼ˆå½“å‰åªæœ‰ä¸€å°ï¼Œä½†ä¿ç•™ä¸€è‡´æ€§å“ˆå¸Œï¼‰
            proxy_pass http://im_server_backend;

            # WebSocket åè®®å‡çº§é…ç½®
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # åŸºç¡€å¤´éƒ¨è®¾ç½®
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # ã€é‡è¦ã€‘ä¼ é€’userIdå’Œè¿æ¥ä¿¡æ¯ç»™åç«¯æœåŠ¡
            proxy_set_header X-User-ID $arg_userId;
            proxy_set_header X-Nginx-Proxy true;
            proxy_set_header X-Connection-Start $msec;  # è¿æ¥å»ºç«‹æ—¶é—´ï¼Œç”¨äºç›‘æ§

            # IMé•¿è¿æ¥è¶…æ—¶é…ç½®
            proxy_read_timeout 86400s;    # 24å°æ—¶è¯»å–è¶…æ—¶ï¼Œé€‚åº”IMé•¿è¿æ¥ç‰¹æ€§
            proxy_send_timeout 86400s;    # 24å°æ—¶å‘é€è¶…æ—¶
            proxy_connect_timeout 30s;    # è¿æ¥è¶…æ—¶ç¼©çŸ­åˆ°30ç§’ï¼Œå¿«é€Ÿå¤±è´¥

            # IMå®æ—¶é€šä¿¡ç¼“å†²åŒºé…ç½®
            proxy_buffering off;         # å…³é—­ç¼“å†²ï¼Œç¡®ä¿æ¶ˆæ¯å®æ—¶æ€§
            proxy_request_buffering off; # å…³é—­è¯·æ±‚ç¼“å†²

            # å•æœåŠ¡å™¨åœºæ™¯é”™è¯¯å¤„ç†
            # proxy_next_upstream off;   # å•æœåŠ¡å™¨æ—¶å¯ä»¥ç¦ç”¨ï¼Œä¹Ÿå¯ä»¥ä¿ç•™ç”¨äºå¥åº·æ£€æŸ¥
        }

        # ==================== å¥åº·æ£€æŸ¥å’Œé™æ€èµ„æº ====================

        # im-connectå¥åº·æ£€æŸ¥æ¥å£
        location /health {
            proxy_pass http://im_server_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # å¥åº·æ£€æŸ¥è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
            proxy_send_timeout 5s;
        }

        # ç½‘å…³å¥åº·æ£€æŸ¥
        location /gateway/health {
            proxy_pass http://im_gateway_backend/actuator/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # å¥åº·æ£€æŸ¥è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
            proxy_send_timeout 5s;
        }

        # é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆå¦‚æœéœ€è¦ï¼‰
        location /static/ {
            alias /home/hzz/nginx/html/static/;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }

        # é»˜è®¤é¡µé¢
        location / {
            root /home/hzz/nginx/html;
            index index.html index.htm;
        }
    }

    # ==================== ã€æ–°å¢ã€‘IMåå°ç®¡ç†ç³»ç»Ÿ ====================
    # ç‹¬ç«‹çš„serverå—ï¼Œå¤„ç†åå°ç®¡ç†ç³»ç»Ÿçš„å‰ç«¯å’ŒAPI
    server {
        listen 8092;  # ä½¿ç”¨ç‹¬ç«‹ç«¯å£ï¼Œä¸APPç«¯ï¼ˆ8090ï¼‰åˆ†ç¦»
        server_name 47.93.209.60;  # ä½ çš„å…¬ç½‘ IP

        # æ—¥å¿—é…ç½® - ä½¿ç”¨ä¸“ç”¨æ—¥å¿—æ ¼å¼
        access_log /home/hzz/nginx/logs/im_console_access.log admin_log;
        error_log  /home/hzz/nginx/logs/im_console_error.log;

        # å­—ç¬¦é›†
        charset utf-8;

        # ==================== å‰ç«¯é™æ€èµ„æºæœåŠ¡ ====================
        location / {
            root /home/hzz/nginx/html/im-console-web;  # Vueå‰ç«¯æ‰“åŒ…åçš„ç›®å½•
            index index.html;
            try_files $uri $uri/ /index.html;  # Vue Router historyæ¨¡å¼æ”¯æŒ

            # é™æ€èµ„æºç¼“å­˜ç­–ç•¥
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                expires 7d;
                add_header Cache-Control "public, immutable";
                access_log off;  # é™æ€èµ„æºä¸è®°å½•è®¿é—®æ—¥å¿—
            }

            # HTMLæ–‡ä»¶ä¸ç¼“å­˜ï¼Œç¡®ä¿æ›´æ–°åŠæ—¶
            location ~* \.html$ {
                expires -1;
                add_header Cache-Control "no-cache, no-store, must-revalidate";
            }
        }

        # ==================== åå°ç®¡ç†APIæ¥å£ä»£ç† ====================
        location /api/ {
            # âœ… è¯·æ±‚é™æµ - é˜²æ­¢æ¶æ„æ”»å‡»
            limit_req zone=admin_api_limit burst=40 nodelay;
            limit_conn admin_conn_limit 10;

            # âœ… CORSå¤„ç† - ç®¡ç†åå°é€šå¸¸ä¸éœ€è¦è·¨åŸŸï¼Œä½†å¦‚æœå‰åç«¯åˆ†ç¦»éƒ¨ç½²åˆ™å¯èƒ½éœ€è¦
            # å¦‚æœå‰ç«¯å’Œnginxåœ¨åŒä¸€åŸŸåä¸‹ï¼Œå¯ä»¥æ³¨é‡Šæ‰CORSç›¸å…³é…ç½®
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,X-Admin-Id,X-Admin-Name' always;
                add_header 'Access-Control-Max-Age' '86400' always;
                return 204;
            }

            # ä¸ºå®é™…è¯·æ±‚æ·»åŠ CORSå“åº”å¤´ï¼ˆå¦‚æœéœ€è¦ï¼‰
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,X-Admin-Id,X-Admin-Name' always;
            add_header 'Access-Control-Expose-Headers' 'Authorization,Content-Type' always;

            # ä»£ç†åˆ°åç«¯im-consoleæœåŠ¡
            proxy_pass http://im_console_backend/api/;

            # âœ… ä¼ é€’ç®¡ç†å‘˜ä¿¡æ¯åˆ°åç«¯ï¼ˆä»è¯·æ±‚å¤´ä¸­è·å–ï¼‰
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # âœ… ä¼ é€’ç®¡ç†å‘˜è®¤è¯ä¿¡æ¯
            # å‰ç«¯éœ€è¦å°†tokenæ”¾åœ¨Authorizationå¤´ï¼ŒadminIdæ”¾åœ¨X-Admin-Idå¤´
            proxy_set_header X-Admin-Id $http_x_admin_id;
            proxy_set_header X-Admin-Name $http_x_admin_name;

            # HTTP/1.1 æ”¯æŒ
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # è¶…æ—¶é…ç½® - ç®¡ç†åå°æ“ä½œå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼ˆå¦‚å¯¼å‡ºæ•°æ®ï¼‰
            proxy_connect_timeout 30s;
            proxy_read_timeout 120s;
            proxy_send_timeout 120s;

            # ç¼“å†²é…ç½®
            proxy_buffering on;
            proxy_buffer_size 8k;
            proxy_buffers 16 8k;

            # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶ï¼ˆç®¡ç†åå°å¯èƒ½éœ€è¦ä¸Šä¼ å›¾ç‰‡ã€æ–‡ä»¶ç­‰ï¼‰
            client_max_body_size 50M;

            # é”™è¯¯å¤„ç†
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        }

        # ==================== å¥åº·æ£€æŸ¥ ====================
        location /health {
            access_log off;
            return 200 "IM Console Admin: OK\n";
            add_header Content-Type text/plain;
        }

        # ==================== å®‰å…¨é…ç½® ====================
        # æ‹’ç»è®¿é—®éšè—æ–‡ä»¶
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }

        # æ‹’ç»è®¿é—®å¤‡ä»½æ–‡ä»¶å’Œé…ç½®æ–‡ä»¶
        location ~* \.(bak|config|sql|fla|psd|zip|rar|tar|gz)$ {
            deny all;
            access_log off;
            log_not_found off;
        }
    }

    # ==================== ã€IMç³»ç»Ÿç›‘æ§ã€‘nginxçŠ¶æ€ç›‘æ§ ====================

    # nginxçŠ¶æ€ç›‘æ§ - é‡è¦ï¼šç”¨äºç›‘æ§IMè¿æ¥æ•°
    server {
        listen 8080;
        server_name localhost;

        # nginxåŸºç¡€çŠ¶æ€ï¼ˆæ³¨é‡Šæ‰ï¼Œå› ä¸ºnginxæœªç¼–è¯‘stub_statusæ¨¡å—ï¼‰
        # location /nginx_status {
        #     stub_status on;
        #     access_log off;
        #     allow 127.0.0.1;
        #     allow 192.168.1.0/24;  # å…è®¸å†…ç½‘è®¿é—®
        #     deny all;
        # }

        # è‡ªå®šä¹‰IMè¿æ¥ç»Ÿè®¡ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
        location /im_status {
            access_log off;
            allow 127.0.0.1;
            allow 192.168.1.0/24;
            deny all;

            # è¿”å›ç®€å•çš„çŠ¶æ€ä¿¡æ¯
            return 200 "IM Server Status: Single Server Mode\nIM Server: 192.168.1.150:10001\nConsistent Hash: Enabled (userId-based)\nIM Console: 192.168.1.150:8084 (Port 8092)\nNote: nginx_status disabled (module not available)\n";
            add_header Content-Type text/plain;
        }

        # å¥åº·æ£€æŸ¥ç«¯ç‚¹
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # æœåŠ¡å™¨çŠ¶æ€é¡µé¢ï¼ˆæ–¹ä¾¿æŸ¥çœ‹ï¼‰
        location /server_info {
            access_log off;
            allow 127.0.0.1;
            allow 192.168.1.0/24;
            deny all;

            return 200 "IM System Configuration:\n- Mode: Single Server with Consistent Hashing\n- IM Server: 192.168.1.150:10001 (Port 8090)\n- Gateway: 192.168.1.150:8081\n- Console: 192.168.1.150:8084 (Port 8092)\n- Hash Method: userId-based consistent hashing\n- Ready for horizontal scaling\n";
            add_header Content-Type text/plain;
        }
    }
}
