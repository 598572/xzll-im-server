# IMç³»ç»Ÿ - å•æœåŠ¡å™¨ä¸€è‡´æ€§å“ˆå¸Œé…ç½®
# å½“å‰é…ç½®ï¼šåªæœ‰ä¸€ä¸ªim-connectæœåŠ¡å™¨ï¼Œä½†ä¿ç•™ä¸€è‡´æ€§å“ˆå¸Œä»¥ä¾¿å°†æ¥æ‰©å±•
user root;
worker_processes auto;
error_log /home/hzz/nginx/logs/error.log;
pid /home/hzz/nginx/logs/nginx.pid;

# äº‹ä»¶æ¨¡å— - IMåœºæ™¯ä¼˜åŒ–
events {
    worker_connections 8192;      # IMç³»ç»Ÿéœ€è¦æ”¯æŒå¤§é‡é•¿è¿æ¥
    use epoll;                    # Linuxä¸‹ä½¿ç”¨epollï¼Œé«˜æ•ˆå¤„ç†å¤§é‡è¿æ¥
    multi_accept on;              # ä¸€æ¬¡æ¥å—å¤šä¸ªè¿æ¥ï¼Œæå‡æ€§èƒ½
    accept_mutex off;             # å…³é—­äº’æ–¥é”ï¼Œé¿å…æƒŠç¾¤é—®é¢˜
}

# HTTP æ¨¡å—
http {
    # åŸºç¡€é…ç½®
    include /home/hzz/nginx/conf/mime.types;
    default_type application/octet-stream;
    
    # æ—¥å¿—æ ¼å¼ - å¢å¼ºç‰ˆï¼Œå¢åŠ upstreamå’ŒuserIdä¿¡æ¯ä¾¿äºè°ƒè¯•
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'upstream_addr="$upstream_addr" '
                    'upstream_status="$upstream_status" '
                    'request_time=$request_time '
                    'userId="$arg_userId"';
    
    # IMåœºæ™¯æ€§èƒ½ä¼˜åŒ–
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;               # å¯¹IMå®æ—¶æ€§å¾ˆé‡è¦ï¼Œç¦ç”¨Nagleç®—æ³•
    keepalive_timeout 300;        # IMåœºæ™¯å»¶é•¿keepaliveæ—¶é—´åˆ°5åˆ†é’Ÿ
    keepalive_requests 10000;     # å¢åŠ å•ä¸ªè¿æ¥å¯å¤„ç†çš„è¯·æ±‚æ•°
    types_hash_max_size 2048;
    client_max_body_size 100M;
    
    # IMåœºæ™¯ç‰¹æ®Šä¼˜åŒ–
    proxy_connect_timeout 10s;    # ä»£ç†è¿æ¥è¶…æ—¶
    proxy_send_timeout 300s;      # ä»£ç†å‘é€è¶…æ—¶ï¼Œé€‚åº”IMé•¿è¿æ¥
    proxy_read_timeout 300s;      # ä»£ç†è¯»å–è¶…æ—¶ï¼Œé€‚åº”IMé•¿è¿æ¥
    send_timeout 300s;            # å‘é€è¶…æ—¶
    
    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    # ==================== ä¸Šæ¸¸æœåŠ¡å™¨ç»„å®šä¹‰ ====================
    
    # ç½‘å…³æœåŠ¡å™¨ç»„ - å¤„ç†HTTP APIè¯·æ±‚
    upstream im_gateway_backend {
        # ç½‘å…³æœåŠ¡å™¨åœ°å€ - 8081ç«¯å£
        server 192.168.1.150:8081;
        # æœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šç½‘å…³å®ä¾‹ï¼š
        # server 192.168.1.151:8081;
        # server 192.168.1.152:8081;
        
        # ç½‘å…³è¿æ¥æ± ä¼˜åŒ–
        keepalive 32;                     # ç½‘å…³è¿æ¥æ± 
        keepalive_requests 1000;          # ç½‘å…³è¯·æ±‚æ•°é™åˆ¶
        keepalive_timeout 60s;            # ç½‘å…³è¿æ¥è¶…æ—¶
    }
    
    # ã€é‡ç‚¹ã€‘im-connect WebSocketæœåŠ¡å™¨ç»„ - å•æœåŠ¡å™¨ä¸€è‡´æ€§å“ˆå¸Œ
    upstream im_server_backend {
        # ğŸ¯ å½“å‰åªæœ‰ä¸€ä¸ªim-connectå®ä¾‹
        server 192.168.1.150:10001 weight=1 max_fails=3 fail_timeout=30s;
        
        # ğŸ“ˆ æœªæ¥æ‰©å±•æ—¶å–æ¶ˆæ³¨é‡Šä»¥ä¸‹é…ç½®ï¼š
        # server 192.168.1.151:10001 weight=1 max_fails=3 fail_timeout=30s;
        # server 192.168.1.152:10001 weight=1 max_fails=3 fail_timeout=30s;
        # server 192.168.1.153:10001 weight=1 max_fails=3 fail_timeout=30s;
        
        # ã€å…³é”®é…ç½®ã€‘åŸºäºuserIdå‚æ•°çš„ä¸€è‡´æ€§å“ˆå¸Œ
        # å³ä½¿åªæœ‰ä¸€ä¸ªæœåŠ¡å™¨ï¼Œä¹Ÿä¿ç•™æ­¤é…ç½®ï¼Œä¾¿äºå°†æ¥æ°´å¹³æ‰©å±•
        # å½“WebSocketè¿æ¥æ—¶ï¼ŒURLæ ¼å¼ä¸º: ws://domain/websocket?userId=123456
        hash $arg_userId consistent;
        
        # å•æœåŠ¡å™¨åœºæ™¯è¿æ¥æ± ä¼˜åŒ–
        keepalive 64;                     # å•æœåŠ¡å™¨é€‚ä¸­çš„è¿æ¥æ± å¤§å°
        keepalive_requests 10000;         # å•ä¸ªkeepaliveè¿æ¥å¤„ç†æ›´å¤šè¯·æ±‚
        keepalive_timeout 300s;           # keepaliveè¿æ¥è¶…æ—¶æ—¶é—´
    }

    # æœåŠ¡å™¨é…ç½®
    server {
        listen 80;
        server_name 120.46.85.43;  # ä½ çš„å…¬ç½‘ IP
        
        # æ—¥å¿—é…ç½®
        access_log /home/hzz/nginx/logs/im_access.log main;
        error_log  /home/hzz/nginx/logs/im_error.log;

        # ==================== HTTP APIæ¥å£ä»£ç†åˆ°ç½‘å…³ ====================
        
        # è®¤è¯æœåŠ¡æ¥å£ä»£ç†
        location /im-auth/ {
            proxy_pass http://im_gateway_backend/im-auth/;
            
            # åŸºç¡€ä»£ç†å¤´è®¾ç½®
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # HTTP/1.1 æ”¯æŒ
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # è¶…æ—¶é…ç½®
            proxy_connect_timeout 30s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
            
            # ç¼“å†²é…ç½®
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            
            # é”™è¯¯å¤„ç†
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        }
        
        # ä¸šåŠ¡æœåŠ¡æ¥å£ä»£ç†
        location /im-business/ {
            proxy_pass http://im_gateway_backend/im-business/;
            
            # åŸºç¡€ä»£ç†å¤´è®¾ç½®
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # HTTP/1.1 æ”¯æŒ
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # è¶…æ—¶é…ç½®
            proxy_connect_timeout 30s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
            
            # ç¼“å†²é…ç½®
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
            
            # é”™è¯¯å¤„ç†
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        }

        # ==================== ã€æ ¸å¿ƒã€‘WebSocketé•¿è¿æ¥ä»£ç† - userIdä¸€è‡´æ€§å“ˆå¸Œ ====================
        
        # WebSocket é•¿è¿æ¥è·¯ç”± - åŸºäºuserIdå“ˆå¸Œï¼ˆå•æœåŠ¡å™¨é…ç½®ï¼‰
        location /websocket {
            # ã€é‡è¦ã€‘æ£€æŸ¥userIdå‚æ•°æ˜¯å¦å­˜åœ¨
            if ($arg_userId = "") {
                return 400 "userId parameter is required";
            }
            
            # åå‘ä»£ç†åˆ°im-connectæœåŠ¡å™¨ï¼ˆå½“å‰åªæœ‰ä¸€å°ï¼Œä½†ä¿ç•™ä¸€è‡´æ€§å“ˆå¸Œï¼‰
            proxy_pass http://im_server_backend;
            
            # WebSocket åè®®å‡çº§é…ç½®
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # åŸºç¡€å¤´éƒ¨è®¾ç½®
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # ã€é‡è¦ã€‘ä¼ é€’userIdå’Œè¿æ¥ä¿¡æ¯ç»™åç«¯æœåŠ¡
            proxy_set_header X-User-ID $arg_userId;
            proxy_set_header X-Nginx-Proxy true;
            proxy_set_header X-Connection-Start $msec;  # è¿æ¥å»ºç«‹æ—¶é—´ï¼Œç”¨äºç›‘æ§
            
            # IMé•¿è¿æ¥è¶…æ—¶é…ç½®
            proxy_read_timeout 86400s;    # 24å°æ—¶è¯»å–è¶…æ—¶ï¼Œé€‚åº”IMé•¿è¿æ¥ç‰¹æ€§
            proxy_send_timeout 86400s;    # 24å°æ—¶å‘é€è¶…æ—¶
            proxy_connect_timeout 30s;    # è¿æ¥è¶…æ—¶ç¼©çŸ­åˆ°30ç§’ï¼Œå¿«é€Ÿå¤±è´¥
            
            # IMå®æ—¶é€šä¿¡ç¼“å†²åŒºé…ç½®
            proxy_buffering off;         # å…³é—­ç¼“å†²ï¼Œç¡®ä¿æ¶ˆæ¯å®æ—¶æ€§
            proxy_request_buffering off; # å…³é—­è¯·æ±‚ç¼“å†²
            
            # å•æœåŠ¡å™¨åœºæ™¯é”™è¯¯å¤„ç†
            # proxy_next_upstream off;   # å•æœåŠ¡å™¨æ—¶å¯ä»¥ç¦ç”¨ï¼Œä¹Ÿå¯ä»¥ä¿ç•™ç”¨äºå¥åº·æ£€æŸ¥
        }
        
        # ==================== å¥åº·æ£€æŸ¥å’Œé™æ€èµ„æº ====================
        
        # im-connectå¥åº·æ£€æŸ¥æ¥å£
        location /health {
            proxy_pass http://im_server_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # å¥åº·æ£€æŸ¥è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
            proxy_send_timeout 5s;
        }
        
        # ç½‘å…³å¥åº·æ£€æŸ¥
        location /gateway/health {
            proxy_pass http://im_gateway_backend/actuator/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # å¥åº·æ£€æŸ¥è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 5s;
            proxy_read_timeout 5s;
            proxy_send_timeout 5s;
        }
        
        # é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆå¦‚æœéœ€è¦ï¼‰
        location /static/ {
            alias /home/hzz/nginx/html/static/;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
        
        # é»˜è®¤é¡µé¢
        location / {
            root /home/hzz/nginx/html;
            index index.html index.htm;
        }
    }
    
    # ==================== ã€IMç³»ç»Ÿç›‘æ§ã€‘nginxçŠ¶æ€ç›‘æ§ ====================
    
    # nginxçŠ¶æ€ç›‘æ§ - é‡è¦ï¼šç”¨äºç›‘æ§IMè¿æ¥æ•°
    server {
        listen 8080;
        server_name localhost;
        
        # nginxåŸºç¡€çŠ¶æ€ï¼ˆæ³¨é‡Šæ‰ï¼Œå› ä¸ºnginxæœªç¼–è¯‘stub_statusæ¨¡å—ï¼‰
        # location /nginx_status {
        #     stub_status on;
        #     access_log off;
        #     allow 127.0.0.1;
        #     allow 192.168.1.0/24;  # å…è®¸å†…ç½‘è®¿é—®
        #     deny all;
        # }
        
        # è‡ªå®šä¹‰IMè¿æ¥ç»Ÿè®¡ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
        location /im_status {
            access_log off;
            allow 127.0.0.1;
            allow 192.168.1.0/24;
            deny all;
            
            # è¿”å›ç®€å•çš„çŠ¶æ€ä¿¡æ¯
            return 200 "IM Server Status: Single Server Mode\nIM Server: 192.168.1.150:10001\nConsistent Hash: Enabled (userId-based)\nNote: nginx_status disabled (module not available)\n";
            add_header Content-Type text/plain;
        }
        
        # å¥åº·æ£€æŸ¥ç«¯ç‚¹
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
        
        # æœåŠ¡å™¨çŠ¶æ€é¡µé¢ï¼ˆæ–¹ä¾¿æŸ¥çœ‹ï¼‰
        location /server_info {
            access_log off;
            allow 127.0.0.1;
            allow 192.168.1.0/24;
            deny all;
            
            return 200 "IM System Configuration:\n- Mode: Single Server with Consistent Hashing\n- IM Server: 192.168.1.150:10001\n- Gateway: 192.168.1.150:8081\n- Hash Method: userId-based consistent hashing\n- Ready for horizontal scaling\n";
            add_header Content-Type text/plain;
        }
    }
}
