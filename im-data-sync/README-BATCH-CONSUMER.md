# Data-Sync 批量消费模式启动说明

## 🚀 概述

本文档说明如何启动Data-Sync服务的批量消费模式，这是性能最高的数据同步方案。

## 📋 启动方式

### 方式1：使用默认配置启动（推荐）

```bash
# 使用默认配置文件 application.yml
java -jar data-sync.jar
```

### 方式2：使用批量消费专用配置启动

```bash
# 使用批量消费专用配置文件
java -jar data-sync.jar --spring.profiles.active=batch-consumer
```

### 方式3：指定配置文件启动

```bash
# 指定配置文件路径
java -jar data-sync.jar --spring.config.location=classpath:application-batch-consumer.yml
```

## ⚙️ 配置说明

### RocketMQ批量消费配置

```yaml
rocketmq:
  consumer:
    # 单次消费最大消息数 - 关键配置
    consume-message-batch-max-size: 200
    # 消费线程数
    consume-thread-max: 32
    # 是否启用批量消费
    batch-enabled: true
```

### ES批量写入配置

```yaml
es:
  batch:
    # 批量大小
    batch-size: 200
    # 缓冲区大小
    buffer-size: 50000
    # 处理间隔
    process-interval-ms: 200
```

## 🔧 性能调优建议

### 1. 批量大小调优

| 场景 | 推荐批量大小 | 说明 |
|------|-------------|------|
| 高并发 | 200-500 | 大批量，高吞吐量 |
| 低延迟 | 50-100 | 小批量，低延迟 |
| 平衡模式 | 100-200 | 平衡性能和延迟 |

### 2. 线程数调优

```yaml
# 根据CPU核心数调整
rocketmq:
  consumer:
    consume-thread-max: ${CPU核心数 * 2}
```

### 3. 内存配置

```bash
# JVM内存配置建议
-Xms2g -Xmx4g -XX:+UseG1GC
```

## 📊 性能监控

### 1. 查看消费状态

访问监控端点：
```
GET /monitor/stats
GET /monitor/health
```

### 2. 关键指标

- **消息处理速度**: 每秒处理消息数
- **批量处理效率**: 平均每条消息处理时间
- **ES写入性能**: 批量写入耗时
- **错误率**: 消息处理失败率

## 🚨 注意事项

### 1. 内存使用

- 批量消费会占用更多内存
- 建议监控JVM内存使用情况
- 根据实际情况调整批量大小

### 2. 错误处理

- 批量消费中单条消息失败不影响整批
- 失败的消息会进入重试队列
- 建议监控错误日志

### 3. 监控告警

- 设置消息积压告警
- 监控ES写入性能
- 关注系统资源使用情况

## 🔍 故障排查

### 1. 消息积压

```bash
# 检查RocketMQ消费状态
# 检查ES写入性能
# 调整批量大小和线程数
```

### 2. 内存溢出

```bash
# 减少批量大小
# 增加JVM内存
# 检查内存泄漏
```

### 3. ES写入慢

```bash
# 检查ES集群状态
# 优化ES索引配置
# 调整批量写入参数
```

## 📈 性能预期

使用批量消费模式后，预期性能提升：

| 指标 | 提升倍数 | 说明 |
|------|----------|------|
| 吞吐量 | 5-10倍 | 批量处理大幅提升 |
| 资源消耗 | 降低30-50% | 减少网络和CPU开销 |
| 响应时间 | 降低60-80% | 批量写入ES更快 |

## 🎯 最佳实践

1. **从小批量开始**: 先使用100-200的批量大小
2. **逐步调优**: 根据实际性能逐步增加批量大小
3. **监控告警**: 设置完善的监控和告警机制
4. **压力测试**: 在生产环境使用前进行充分测试
5. **备份方案**: 保留原有的单条消费模式作为备选 