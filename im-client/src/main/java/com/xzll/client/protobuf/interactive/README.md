# 交互式测试客户端使用指南

## 📋 简介

这是一个智能的交互式IM测试客户端，专门用于与移动端APP联调消息发送功能。

### 核心特性

- ✅ **灵活的用户输入**：启动时输入发送方ID，发消息时指定接收方
- ✅ **实时消息接收**：自动显示收到的消息、ACK、好友请求等
- ✅ **多种发送模式**：完整模式（每次输入接收方）和快速模式（连续发送给同一人）
- ✅ **友好的界面**：带颜色和表情符号的美观界面
- ✅ **统计信息**：实时显示已发送和已接收的消息数

## 🚀 快速开始

### 步骤 1: 启动客户端

在 IDEA 中直接运行 `InteractiveTestClient.java`

或使用 Maven：
```bash
cd im-client
mvn exec:java -Dexec.mainClass="com.xzll.client.protobuf.interactive.InteractiveTestClient"
```

### 步骤 2: 输入用户ID

```
╔════════════════════════════════════════════════════╗
║     交互式 IM 测试客户端 - 启动配置               ║
╚════════════════════════════════════════════════════╝

请输入当前用户ID（发送方，例如: user1）: testuser
✅ 当前用户: testuser

正在连接服务器...
✅ 连接成功！
```

### 步骤 3: 使用命令

连接成功后，可以使用以下命令：

## 📝 命令列表

### 1. 发送消息（完整模式）

```bash
> send
# 或简写
> s
```

然后按提示输入：
```
┌─────────────────────────────────────┐
│        发送消息（完整模式）         │
└─────────────────────────────────────┘
接收方用户ID: user2
消息内容: 你好，这是一条测试消息

✅ 消息已发送
   发送方: testuser
   接收方: user2
   内容: 你好，这是一条测试消息
```

### 2. 快速发送模式

```bash
> quick user2
# 或简写
> q user2
```

进入快速发送模式后，可以连续发送多条消息：
```
┌─────────────────────────────────────┐
│      快速发送模式（连续发送）       │
│      接收方: user2                  │
│      输入 'back' 返回主菜单         │
└─────────────────────────────────────┘

[发送给 user2] > 第一条消息
  ✓ 已发送
[发送给 user2] > 第二条消息
  ✓ 已发送
[发送给 user2] > back
✅ 退出快速发送模式
```

### 3. 查看状态

```bash
> status
```

输出：
```
┌─────────────────────────────────────┐
│            当前连接状态             │
├─────────────────────────────────────┤
│  当前用户: testuser
│  连接状态: ✅ 已连接
│  已发送: 5 条
│  已接收: 3 条
└─────────────────────────────────────┘
```

### 4. 帮助信息

```bash
> help
# 或简写
> h
```

### 5. 好友请求管理

#### 查看待处理的好友请求
```bash
> friend list
# 或简写
> f l
```

输出：
```
╔════════════════════════════════════════════════════╗
║            待处理的好友请求列表                     ║
╠════════════════════════════════════════════════════╣
║
║  [1] 申请人: 张三 (user3)
║      消息: 我想加你为好友
║      请求ID: req-123-abc
║      同意: friend accept req-123-abc
║      拒绝: friend reject req-123-abc
╚════════════════════════════════════════════════════╝
```

#### 同意好友请求
```bash
> friend accept req-123-abc
# 或简写
> f a req-123-abc
```

#### 拒绝好友请求
```bash
> friend reject req-123-abc
# 或简写
> f r req-123-abc
```

### 6. 清屏

```bash
> clear
# 或简写
> cls
```

### 7. 退出程序

```bash
> exit
# 或
> quit
```

## 📨 消息接收示例

### 收到单聊消息

```
╔════════════════════════════════════════════════════╗
║              📨 收到新消息                          ║
╠════════════════════════════════════════════════════╣
║  时间: 15:30:45
║  发送方: user2
║  消息ID: abc-123-def
║  内容: 你好啊！
╚════════════════════════════════════════════════════╝

[15:30:45] 📡 ACK: 服务器已接收 (msgId: abc-123-def)
[15:30:45] 📬 ACK: 对方未读 (msgId: abc-123-def)
[15:30:46] ✅ ACK: 对方已读 (msgId: abc-123-def)
```

### 收到好友请求

```
╔════════════════════════════════════════════════════╗
║              👥 收到好友请求                        ║
╠════════════════════════════════════════════════════╣
║  申请人: 张三 (user3)
║  申请消息: 我想加你为好友
║  请求ID: req-456-xyz
╠════════════════════════════════════════════════════╣
║  💡 处理方式:                                      ║
║     同意: friend accept req-456-xyz                ║
║     拒绝: friend reject req-456-xyz                ║
║     查看: friend list                              ║
╚════════════════════════════════════════════════════╝

# 您可以立即处理，或稍后使用 friend list 查看
> friend accept req-456-xyz
[15:30:45] ⏳ 正在处理好友请求...
[15:30:46] ✅ 好友请求处理成功！
   操作: 同意 张三 的好友申请
   响应: {"code":200,"message":"success"}
```

### 收到好友申请响应

```
╔════════════════════════════════════════════════════╗
║            👥 好友申请响应                          ║
╠════════════════════════════════════════════════════╣
║  响应人: 李四
║  结果: ✅ 已同意
║  🎉 李四 同意了你的好友申请
╚════════════════════════════════════════════════════╝
```

## 🎯 典型使用场景

### 场景 1: 与移动端APP联调

1. 启动此测试客户端，输入用户ID：`testuser`
2. 在移动端APP登录另一个用户：`mobileuser`
3. 使用快速模式向移动端发送消息：
   ```bash
   > q mobileuser
   [发送给 mobileuser] > 你好，移动端收到了吗？
   ```
4. 在移动端回复消息
5. 测试客户端会自动显示收到的消息

### 场景 2: 多人聊天测试

启动多个测试客户端实例：

**终端1（user1）**：
```bash
> q user2
[发送给 user2] > 你好user2
```

**终端2（user2）**：
```bash
# 自动收到 user1 的消息
╔════════════════════════════════════════════════════╗
║              📨 收到新消息                          ║
╠════════════════════════════════════════════════════╣
║  发送方: user1
║  内容: 你好user2
╚════════════════════════════════════════════════════╝

> q user1
[发送给 user1] > 你好user1，我收到了
```

### 场景 3: 好友请求测试

**用户A（申请人）**：
```bash
# 通过HTTP接口发送好友请求
curl -X POST http://127.0.0.1:8083/api/friend/request/send \
  -H "Content-Type: application/json" \
  -d '{"fromUserId":"user1","toUserId":"testuser","requestMessage":"你好，我想加你为好友"}'
```

**用户B（被申请人，testuser）**：
```bash
# 自动收到好友请求推送
╔════════════════════════════════════════════════════╗
║              👥 收到好友请求                        ║
╠════════════════════════════════════════════════════╣
║  申请人: user1 (user1)
║  申请消息: 你好，我想加你为好友
║  请求ID: req-xxx-yyy
╠════════════════════════════════════════════════════╣
║  💡 处理方式:                                      ║
║     同意: friend accept req-xxx-yyy                ║
║     拒绝: friend reject req-xxx-yyy                ║
║     查看: friend list                              ║
╚════════════════════════════════════════════════════╝

# 同意请求
> friend accept req-xxx-yyy
[15:30:46] ✅ 好友请求处理成功！
   操作: 同意 user1 的好友申请
```

### 场景 4: 性能测试

使用快速模式连续发送大量消息：
```bash
> q user2

# 编写一个脚本连续输入
for i in {1..100}; do echo "测试消息 $i"; done
```

## 🔧 配置说明

### 修改服务器地址

编辑 `InteractiveTestClient.java` 第 67 行：
```java
URI uri = new URI("ws://127.0.0.1:8081/websocket?userId=" + currentUserId);
// 修改服务器地址和端口（保持 /websocket?userId= 参数）
```

**注意**：
- URL 必须包含 `?userId=` 参数
- 默认端口是 8081
- 路径是 `/websocket`（不是 `/im/ws`）

### 修改认证Token

如果token过期，编辑 `InteractiveTestClient.java` 第 71 行：
```java
headers.set("token", "your-token-here");
```

### 修改消息格式

在 `InteractiveClientHandler.java` 的 `sendTextMessage` 方法中修改：
```java
.setFormat(1) // 1=文本, 2=图片, 3=语音
```

## 💡 使用技巧

### 1. 使用别名简化命令

大部分命令都有简写：
- `send` → `s`
- `quick user2` → `q user2`
- `help` → `h`
- `clear` → `cls`

### 2. 快速模式最高效

如果要连续发送多条消息给同一个人，使用快速模式：
```bash
> q user2
[发送给 user2] > 消息1
[发送给 user2] > 消息2
[发送给 user2] > 消息3
[发送给 user2] > back
```

### 3. 查看历史消息

按 `↑` 和 `↓` 键可以浏览命令历史（终端自带功能）

### 4. 复制粘贴长文本

可以直接粘贴长文本作为消息内容

## ❓ 常见问题

### Q1: 连接失败怎么办？

**A**: 检查：
1. 服务端是否启动（im-connect 服务）
2. 地址和端口是否正确（默认 8081）
3. 防火墙是否开放

### Q2: 消息发送后没有ACK？

**A**: 
- 检查接收方是否在线
- 查看服务端日志是否有错误
- 使用 `status` 命令查看连接状态

### Q3: 如何测试离线消息？

**A**:
1. 启动客户端A（user1）
2. 不启动客户端B（user2）
3. 客户端A向user2发送消息
4. 启动客户端B，应该能收到离线消息

### Q4: 支持发送图片吗？

**A**: 
当前版本只支持文本消息。
如需支持图片，需要修改代码上传图片并发送URL。

### Q5: 好友请求ID从哪里获取？

**A**:
- 收到好友请求时会自动显示请求ID
- 使用 `friend list` 命令可以查看所有待处理请求的ID
- 请求ID格式通常为：`req-xxx-yyy`

## 📊 对比其他测试客户端

| 特性 | InteractiveTestClient | Client1 | Client2 |
|------|----------------------|---------|---------|
| **灵活指定接收方** | ✅ | ❌ 固定 | ❌ 固定 |
| **交互式命令** | ✅ | ❌ | ❌ |
| **快速连续发送** | ✅ | ❌ | ❌ |
| **实时统计** | ✅ | ❌ | ❌ |
| **好友请求管理** | ✅ 手动处理 | ✅ 只接收 | ✅ 自动同意 |
| **美观界面** | ✅ | ⭐⭐ | ⭐⭐ |
| **适合场景** | 联调测试 | 自动化测试 | 自动化测试 |

## 🎓 学习资源

- [Netty WebSocket 官方文档](https://netty.io/wiki/user-guide-for-4.x.html)
- [Protobuf 使用指南](https://developers.google.com/protocol-buffers)
- [IM 系统设计文档](../../doc/)

## 📅 更新日志

- **2025-10-29**: 初始版本
  - ✅ 实现交互式命令界面
  - ✅ 支持灵活指定发送方和接收方
  - ✅ 支持完整模式和快速模式
  - ✅ 自动处理消息接收和ACK
  - ✅ 支持好友请求管理（同意/拒绝/查看）

---

**Happy Testing!** 🚀

