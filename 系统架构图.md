# XZLL-IM 系统架构图

## 🎯 项目概述

XZLL-IM 是一个基于微服务架构的分布式即时通讯系统，采用 Spring Cloud + Dubbo + Netty 技术栈，支持高并发、高可用的实时消息通信。

---

## 🏗️ 系统架构图

```mermaid
flowchart TD
    %% 客户端层
    subgraph CLIENT ["🖥️ 客户端层"]
        WEB["Web客户端"]
        MOBILE["移动端客户端"] 
        PC["PC客户端"]
    end

    %% 负载均衡层
    subgraph PROXY ["⚖️ 负载均衡层"]
        NGINX["Nginx<br/>负载均衡+反向代理<br/>:80/:443"]
    end

    %% 网关层  
    subgraph GATEWAY ["🚪 网关层"]
        GW["Gateway网关<br/>:8081<br/>Spring Cloud Gateway"]
    end

    %% 业务服务层
    subgraph SERVICES ["🔧 业务服务层 (Docker Compose)"]
        AUTH["认证服务<br/>im-auth:8082<br/>OAuth2+Spring Security"]
        CONNECT["长连接服务<br/>im-connect:10001<br/>Netty WebSocket"]
        BUSINESS["业务服务<br/>im-business:8083<br/>核心消息处理"]
        CONSOLE["控制台服务<br/>im-console:8084<br/>管理后台"]
        DATASYNC["数据同步服务<br/>im-data-sync:8085<br/>HBase→ES同步"]
    end

    %% 中间件层
    subgraph MIDDLEWARE ["⚙️ 中间件层"]
        NACOS["Nacos<br/>服务发现+配置中心<br/>:8848"]
        ZK["ZooKeeper<br/>Dubbo注册中心<br/>:2181"]
        RMQ["RocketMQ<br/>异步消息处理<br/>:9876"]
    end

    %% 存储层
    subgraph STORAGE ["💾 存储层"]
        MYSQL[("MySQL<br/>用户信息/会话数据<br/>:3306")]
        HBASE[("HBase<br/>消息存储<br/>集群部署")]
        REDIS[("Redis<br/>缓存/分布式锁<br/>:6379")]
        ES[("Elasticsearch<br/>消息搜索<br/>:9200")]
    end

    %% 监控层
    subgraph MONITOR ["📊 监控观测"]
        PROMETHEUS["Prometheus<br/>指标采集<br/>:9090"]
        GRAFANA["Grafana<br/>监控面板<br/>:3000"]
    end

    %% CI/CD层
    subgraph CICD ["🚀 CI/CD部署"]
        GIT["Git仓库<br/>源码管理"]
        JENKINS["Jenkins<br/>持续集成<br/>Pipeline脚本"]
        DOCKER["Docker Compose<br/>容器编排部署"]
    end

    %% 客户端连接
    WEB --- NGINX
    MOBILE --- NGINX
    PC --- NGINX

    %% 网关连接
    NGINX --- GW
    NGINX --- CONNECT

    %% 服务连接
    GW --- AUTH
    GW --- BUSINESS
    GW --- CONSOLE

    %% 服务注册发现
    AUTH --- NACOS
    BUSINESS --- NACOS
    CONSOLE --- NACOS
    GW --- NACOS

    %% RPC连接
    CONNECT --- ZK
    BUSINESS --- ZK
    CONNECT -.- BUSINESS

    %% 存储连接
    AUTH --- MYSQL
    BUSINESS --- MYSQL
    BUSINESS --- HBASE
    CONNECT --- REDIS
    BUSINESS --- REDIS

    %% 消息队列
    BUSINESS --- RMQ
    DATASYNC --- RMQ
    DATASYNC --- ES

    %% 监控连接
    CONNECT --- PROMETHEUS
    PROMETHEUS --- GRAFANA

    %% CI/CD流程
    GIT --- JENKINS
    JENKINS --- DOCKER
    DOCKER --- SERVICES

    %% 样式定义
    classDef clientStyle fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef proxyStyle fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef gatewayStyle fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef serviceStyle fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef middlewareStyle fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef storageStyle fill:#fce4ec,stroke:#d81b60,stroke-width:2px
    classDef monitorStyle fill:#f1f8e9,stroke:#689f38,stroke-width:2px
    classDef cicdStyle fill:#e0f2f1,stroke:#00796b,stroke-width:2px

    class CLIENT,WEB,MOBILE,PC clientStyle
    class PROXY,NGINX proxyStyle
    class GATEWAY,GW gatewayStyle
    class SERVICES,AUTH,CONNECT,BUSINESS,CONSOLE,DATASYNC serviceStyle
    class MIDDLEWARE,NACOS,ZK,RMQ middlewareStyle
    class STORAGE,MYSQL,HBASE,REDIS,ES storageStyle
    class MONITOR,PROMETHEUS,GRAFANA monitorStyle
    class CICD,JENKINS,DOCKER,GIT cicdStyle
```

---

## 📋 核心模块详解

### 🌐 负载均衡与网关层
| 服务 | 端口 | 职责 | 技术栈 |
|------|------|------|--------|
| **Nginx** | 80/443 | 负载均衡，反向代理，SSL终止 | Nginx |
| **im-gateway** | 8081 | 统一API网关，路由转发，服务发现 | Spring Cloud Gateway |

### 🔐 业务服务层
| 服务 | 端口 | 职责 | 技术栈 |
|------|------|------|--------|
| **im-auth** | 8082 | 用户认证、授权、JWT令牌管理 | OAuth2 + Spring Security |
| **im-connect** | 10001 | WebSocket长连接管理，实时消息推送 | Netty + WebSocket |
| **im-business** | 8083 | 核心业务逻辑，消息处理，数据持久化 | Spring Boot + Dubbo |
| **im-console** | 8084 | 管理后台，消息查询，系统监控 | Spring Boot |
| **im-data-sync** | 8085 | 数据同步，HBase到ES的异步同步 | Spring Boot + RocketMQ |

### 🗃️ 存储架构

#### 主存储系统
- **MySQL**: 用户信息、会话数据、好友关系等结构化数据
- **HBase**: 海量消息记录存储，支持高并发写入
- **Redis**: 缓存用户状态、在线信息、分布式锁

#### 搜索引擎
- **Elasticsearch**: 消息全文搜索、复杂查询、数据分析

---

## 🔄 核心业务流程

### 📱 用户登录流程
```mermaid
sequenceDiagram
    participant C as 客户端
    participant G as Gateway
    participant A as Auth服务
    participant M as MySQL
    participant R as Redis
    participant CON as Connect服务

    C->>G: 登录请求(username/password/device_type)
    G->>A: 转发认证请求
    A->>M: 查询用户信息验证凭据
    M->>A: 返回用户数据
    A->>A: 生成JWT Token
    A->>R: 存储Token和用户ID映射
    A->>G: 返回JWT Token
    G->>C: 登录成功响应
    Note over C: 客户端使用Token建立WebSocket连接
    C->>CON: WebSocket连接(携带Token)
    CON->>R: 验证Token有效性
    R->>CON: Token验证通过
    CON->>C: WebSocket连接建立成功
```

### 💬 单聊消息发送流程
```mermaid
sequenceDiagram
    participant C1 as 发送方客户端
    participant CON as Connect服务
    participant MQ as RocketMQ
    participant BIZ as Business服务
    participant M as MySQL
    participant H as HBase
    participant R as Redis
    participant DS as DataSync服务
    participant ES as Elasticsearch
    participant C2 as 接收方客户端

    Note over C1,C2: 1. 消息接收与并行处理阶段
    C1->>CON: 发送消息(WebSocket)
    CON->>CON: 策略分发(C2CMsgSendStrategyImpl)
    
    par 并行处理：异步业务处理 & 实时消息路由
        CON->>MQ: 发送到RocketMQ(异步削峰业务处理)
    and
        CON->>R: 查询接收方在线状态
        CON->>CON: 根据在线状态决定路由策略
    end
    
    Note over MQ,BIZ: 2. 异步业务处理阶段
    MQ->>BIZ: 消费消息(C2CMsgEventConsumer)
    BIZ->>BIZ: C2CSendMsgHandler处理
    par 并行数据存储
        BIZ->>M: 更新/创建会话信息(MySQL)
    and 
        BIZ->>H: 存储消息记录(HBase)
        H->>BIZ: HBase存储成功
        BIZ->>MQ: 立即发送ES同步消息
    end
    BIZ->>R: 增加接收方未读计数
    BIZ->>CON: Dubbo RPC发送Server ACK
    CON->>C1: 推送Server ACK确认
    
    Note over CON,C2: 3. 实时消息路由阶段(与业务处理并行)
    alt 接收方在线且在本机
        CON->>C2: 直接推送消息(WebSocket)
    else 接收方在线但在其他机器
        CON->>CON: Dubbo RPC转发到目标机器
        CON->>C2: 推送消息(WebSocket)
    else 接收方离线
        CON->>MQ: 发送离线消息事件
        MQ->>BIZ: 处理离线消息(C2COffLineMsgHandler)
        BIZ->>H: 更新消息状态为离线
        H->>BIZ: 更新成功确认
        BIZ->>MQ: 发送状态更新同步消息
        BIZ->>R: 存储离线消息缓存
        BIZ->>CON: 伪造未读ACK给发送方
        CON->>C1: 推送未读ACK
    end
    
    Note over C2,C1: 4. 消息确认阶段
    C2->>CON: 发送已读/未读ACK
    CON->>MQ: 转发ACK到RocketMQ
    MQ->>BIZ: 处理ACK(C2CClientReceivedAckMsgHandler)
    BIZ->>H: 更新消息状态
    H->>BIZ: 更新成功确认
    BIZ->>MQ: 发送状态更新同步消息
    BIZ->>R: 清零未读计数(如果已读)
    BIZ->>CON: Dubbo RPC发送ACK给发送方
    CON->>C1: 推送ACK确认
    
    Note over MQ,ES: 5. ES数据同步阶段(消息发送时触发)
    Note over BIZ,DS: 在消息发送阶段HBase写入成功后立即触发ES同步
    par ES数据同步处理
        MQ->>DS: 消费ES同步消息(BatchDataSyncConsumer)
        DS->>DS: 批量解析消息并按操作类型分组
        DS->>ES: BulkRequest批量写入搜索引擎
        ES->>DS: 批量写入结果确认
    end
```

---

## 🛠️ 技术栈详情

### 核心框架
- **Spring Boot**: 2.7.0
- **Spring Cloud**: 2021.0.3  
- **Dubbo**: 3.0.7
- **Netty**: 4.1.75.Final

### 中间件
- **Nacos**: 服务发现 + 配置中心
- **ZooKeeper**: Dubbo注册中心
- **RocketMQ**: 4.5.0 异步消息处理
- **Redis**: 缓存 + 分布式锁
- **Redisson**: 分布式锁实现

### 数据存储
- **MySQL**: 8.0.23 关系型数据
- **HBase**: 2.5.7-hadoop3 消息存储
- **Elasticsearch**: 全文搜索
- **MyBatis Plus**: ORM框架

### 监控运维
- **Prometheus**: 指标采集
- **Grafana**: 监控面板
- **Docker**: 容器化部署
- **Jenkins**: CI/CD

---

## 📊 数据库设计

### 核心数据表
| 表名 | 用途 | 存储引擎 |
|------|------|----------|
| `im_user` | 用户基本信息 | MySQL |
| `im_chat` | 会话信息 | MySQL |
| `im_chat_user_opt` | 用户会话操作记录 | MySQL |
| `im_friend_relation` | 好友关系 | MySQL |
| `c2c_msg_record` | 单聊消息记录 | HBase |

### 消息存储策略
- **HBase**: 主存储，RowKey设计支持高效查询
- **Elasticsearch**: 辅助存储，支持全文搜索和复杂查询
- **Redis**: 缓存热点数据，提升查询性能

---

## 🚀 系统特性

### 高可用性
- 微服务架构，服务独立部署
- Nacos服务发现，自动故障转移
- Redis集群，数据高可用

### 高性能
- Netty NIO高性能网络框架
- HBase分布式存储，支持海量数据
- Redis缓存，毫秒级响应
- 异步消息处理，削峰填谷

### 可扩展性
- 水平扩展，按需增加服务实例
- 数据分库分表支持
- 插件化消息处理器

### 可观测性
- Prometheus指标监控
- Grafana可视化面板
- 分布式链路追踪（规划中）

---

## 🚀 部署架构

### 📦 CI/CD 流程
```mermaid
graph LR
    A[开发推送代码] --> B[Git仓库]
    B --> C[Jenkins Pipeline触发]
    C --> D[Maven构建打包]
    D --> E[Docker镜像构建]
    E --> F[Docker Compose部署]
    F --> G[服务健康检查]
    G --> H[部署完成]
```

### 🐳 Docker Compose 服务编排
- **统一部署**: 所有微服务通过docker-compose.yml统一编排
- **网络隔离**: 服务间通过Docker网络通信
- **数据持久化**: 关键数据目录挂载到宿主机
- **日志集中**: 统一日志目录便于运维管理

### 🌐 Nginx 配置策略
- **负载均衡**: 多实例服务的负载分发
- **反向代理**: 隐藏内部服务端口，统一对外暴露
- **SSL终止**: HTTPS证书管理和SSL卸载
- **静态资源**: 前端静态文件服务

---

## 🔮 发展规划

### 已实现功能 ✅
- 用户认证与授权
- 单聊消息发送与接收
- 消息存储与搜索
- 服务监控与告警
- Docker容器化部署
- Jenkins CI/CD流水线
- Nginx负载均衡

### 开发中功能 🚧
- 群聊功能
- 离线消息推送
- 消息加密传输
- 移动端适配

### 规划功能 📋
- Kubernetes部署
- 音视频通话
- 文件传输
- 消息撤回与编辑
- 表情包支持
- 机器人集成

---

## 📊 如何查看Mermaid图形

### 在IDEA中查看
1. **安装插件**: 
   - 打开 IDEA → File → Settings → Plugins
   - 搜索并安装 "Mermaid" 插件
   - 重启IDEA

2. **查看图形**:
   - 打开 `.md` 文件
   - 右键选择 "Open in Browser" 或 "Preview"
   - 或者使用IDEA的Markdown预览面板

### 在线查看方式
1. **Mermaid Live Editor**: https://mermaid.live/
   - 复制mermaid代码直接粘贴查看
   
2. **GitHub/GitLab**: 
   - 直接在仓库中查看markdown文件
   - 自动渲染mermaid图形

3. **VSCode**: 
   - 安装 "Mermaid Preview" 插件
   - 实时预览图形效果

### 其他工具
- **Typora**: 支持原生mermaid渲染
- **Notion**: 支持mermaid图形
- **Obsidian**: 通过插件支持

---

## 📞 联系方式

**作者**: 蝎子莱莱爱打怪  
**邮箱**: h163361631@163.com  
**项目地址**: [GitHub链接]

> 💡 这是一个开源项目，欢迎贡献代码和提出改进建议！
