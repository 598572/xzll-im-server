pipeline {
    agent any

    environment {
        PROJECT_DIR = "/home/hzz/im/jenkins_way_build_docker_compose/xzll-im"
        JAVA_HOME = "/home/hzz/jdk/jdk-21.0.8"
        MAVEN_HOME = "/home/hzz/maven/apache-maven-3.9.11"
    }

    stages {
        stage('Check Code Upload') {
            steps {
                script {
                    log("æ£€æŸ¥ä»£ç æ˜¯å¦å·²é€šè¿‡ SCP ä¸Šä¼ ")
                    
                    if (!fileExists("${PROJECT_DIR}/pom.xml")) {
                        error("""
                        âŒ æœªæ£€æµ‹åˆ°ä»£ç ï¼
                        
                        è¯·å…ˆåœ¨æœ¬åœ°æ‰§è¡Œä¸Šä¼ è„šæœ¬ï¼š
                        ./scp_upload.sh
                        
                        ç„¶åé‡æ–°è§¦å‘æ„å»º
                        """)
                    }
                    
                    log("âœ… æ£€æµ‹åˆ°ä»£ç ï¼Œå‡†å¤‡å¼€å§‹æ„å»º")
                }
            }
        }

        stage('Build Project') {
            steps {
                script {
                    dir(PROJECT_DIR) {
                        log("å¼€å§‹ Maven æ‰“åŒ…")
                        
                        sh """
                            export JAVA_HOME=${env.JAVA_HOME}
                            export PATH=${env.JAVA_HOME}/bin:\${PATH}
                            
                            ${env.MAVEN_HOME}/bin/mvn clean package -P test -DskipTests
                        """
                        
                        exit_on_error("Maven æ‰“åŒ…å¤±è´¥")
                        log("âœ… Maven æ‰“åŒ…å®Œæˆ")
                    }
                }
            }
        }

        stage('Copy JAR Files') {
            steps {
                script {
                    def jarFiles = [
                        'im-gateway/target/im-gateway.jar': 'im-gateway/src/main/resources',
                        'im-connect/im-connect-service/target/im-connect-service.jar': 'im-connect/im-connect-service/src/main/resources',
                        'im-auth/target/im-auth.jar': 'im-auth/src/main/resources',
                        'im-business/im-business-service/target/im-business-service.jar': 'im-business/im-business-service/src/main/resources',
                        'im-console/im-console-service/target/im-console-service.jar': 'im-console/im-console-service/src/main/resources',
                        'im-data-sync/target/im-data-sync.jar': 'im-data-sync/src/main/resources'
                    ]
                    
                    dir(PROJECT_DIR) {
                        jarFiles.each { jar, targetDir ->
                            log("å¤åˆ¶ ${jar} -> ${targetDir}")
                            sh "cp ${jar} ${targetDir}"
                            exit_on_error("å¤åˆ¶ ${jar} å¤±è´¥")
                        }
                        log("âœ… JAR æ–‡ä»¶å¤åˆ¶å®Œæˆ")
                    }
                }
            }
        }

        stage('Deploy with Docker Compose') {
            steps {
                script {
                    dir(PROJECT_DIR) {
                        log("åœæ­¢ç°æœ‰å®¹å™¨")
                        sh "docker compose down"
                        exit_on_error("åœæ­¢å®¹å™¨å¤±è´¥")
                        
                        log("æ„å»ºé•œåƒå¹¶å¯åŠ¨å®¹å™¨")
                        sh "docker compose up -d --build"
                        exit_on_error("å¯åŠ¨å®¹å™¨å¤±è´¥")
                        
                        log("âœ… å®¹å™¨å¯åŠ¨æˆåŠŸ")
                    }
                }
            }
        }

        stage('Clean Up') {
            steps {
                script {
                    log("æ¸…ç† Docker åƒåœ¾")
                    sh "docker system prune -f --volumes"
                    exit_on_error("æ¸…ç†å¤±è´¥")
                    log("âœ… æ¸…ç†å®Œæˆ")
                }
            }
        }
    }

    post {
        always {
            script {
                log("========================================")
                log("éƒ¨ç½²æµç¨‹ç»“æŸ")
                log("========================================")
            }
        }
        success {
            script {
                log("ğŸ‰ æ„å»ºæˆåŠŸï¼")
            }
            emailext (
                subject: "âœ… Jenkins æ„å»ºæˆåŠŸ (SCPæ¨¡å¼): ${currentBuild.fullDisplayName}",
                body: """
                Jenkins æ„å»ºæˆåŠŸé€šçŸ¥ (SCPä¸Šä¼ æ¨¡å¼):
                
                é¡¹ç›®: ${env.JOB_NAME}
                æ„å»ºç¼–å·: ${env.BUILD_NUMBER}
                æ„å»ºURL: ${env.BUILD_URL}
                
                æç¤º: æœ¬æ¬¡æ„å»ºä½¿ç”¨ SCP ä¸Šä¼ çš„ä»£ç 
                """,
                to: 'h163361631@163.com'
            )
        }
        failure {
            script {
                log("âŒ æ„å»ºå¤±è´¥")
            }
            emailext (
                subject: "âŒ Jenkins æ„å»ºå¤±è´¥ (SCPæ¨¡å¼): ${currentBuild.fullDisplayName}",
                body: """
                Jenkins æ„å»ºå¤±è´¥é€šçŸ¥ (SCPä¸Šä¼ æ¨¡å¼):
                
                é¡¹ç›®: ${env.JOB_NAME}
                æ„å»ºç¼–å·: ${env.BUILD_NUMBER}
                æ„å»ºURL: ${env.BUILD_URL}
                
                è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—
                """,
                to: 'h163361631@163.com'
            )
        }
    }
}

def log(message) {
    echo "[${new Date().format('yyyy-MM-dd HH:mm:ss')}] ${message}"
}

def exit_on_error(message) {
    if (currentBuild.result == 'FAILURE') {
        error(message)
    }
}
