# ⚡ 快速开始 - 已修复版本

## 🔧 已修复的问题

✅ **文件句柄不足** - `run-jar.sh` 会自动检查并提升 ulimit  
✅ **连接过早关闭** - 修复心跳逻辑，确保准时发送  
✅ **心跳间隔错误** - 修复 `pace` 导致的阻塞问题  

---

## 🚀 立即开始测试

### 第 1 步：编译并上传 JAR（本地执行）

```bash
# 在本地（Mac）执行
cd /Users/hzz/myself_project/开源09/xzll-im-server/im-stress-gatling

# 编译 JAR
mvn clean package -DskipTests

# 上传到服务器
scp target/im-stress-gatling-1.0.0.jar root@your-server:/home/hzz/压测工具/

# 确保脚本也是最新的
scp run-jar.sh root@your-server:/home/hzz/压测工具/
```

### 第 2 步：服务器上执行测试

```bash
# SSH 登录服务器
ssh root@your-server

# 进入压测目录
cd /home/hzz/压测工具

# 添加执行权限
chmod +x run-jar.sh

# 🔹 小规模测试（100 连接，验证修复）
./run-jar.sh 192.168.1.150 10001 100 30 120 5000 30000
```

**预期结果：**
- ✅ 看到 "文件句柄限制已提升" 的提示
- ✅ 成功率 > 95%
- ✅ 无 "打开的文件过多" 错误
- ✅ 无大量 "Premature close" 错误

### 第 3 步：逐步增加规模

```bash
# 1000 连接
./run-jar.sh 192.168.1.150 10001 1000 60 300 5000 30000

# 10000 连接
./run-jar.sh 192.168.1.150 10001 10000 120 600 5000 30000

# 30000 连接（如果服务器资源充足）
./run-jar.sh 192.168.1.150 10001 30000 300 600 10000 60000
```

---

## 📊 参数说明

```bash
./run-jar.sh <IP> <端口> [用户数] [启动时间s] [测试时长s] [消息间隔ms] [心跳间隔ms]
```

| 参数 | 说明 | 默认值 | 推荐值 |
|------|------|--------|--------|
| **IP** | 目标服务器 IP | 无（必填） | 192.168.1.150 |
| **端口** | WebSocket 端口 | 无（必填） | 10001 |
| **用户数** | 并发连接数 | 10000 | 100 → 1000 → 10000 |
| **启动时间** | 逐步启动（秒） | 120 | 用户数 / 100 |
| **测试时长** | 测试持续时间（秒） | 600 | 300 - 600 |
| **消息间隔** | 发消息间隔（毫秒） | 5000 | 5000 (0=不发) |
| **心跳间隔** | 心跳间隔（毫秒） | 30000 | 30000 |

---

## ⚡ 常用测试场景

### 场景 1：只测连接数（不发消息）

```bash
./run-jar.sh 192.168.1.150 10001 10000 120 300 0
```

**用途**：测试服务器最大连接数

### 场景 2：低频消息（每 10 秒一条）

```bash
./run-jar.sh 192.168.1.150 10001 10000 120 600 10000 60000
```

**用途**：模拟真实用户行为

### 场景 3：高频消息（每 1 秒一条）

```bash
./run-jar.sh 192.168.1.150 10001 5000 120 300 1000 30000
```

**用途**：压测消息 TPS

### 场景 4：极限测试（3 万连接）

```bash
./run-jar.sh 192.168.1.150 10001 30000 300 600 10000 60000
```

**用途**：测试服务器极限

---

## 🔍 监控关键指标

### 客户端监控

```bash
# 压测过程中观察输出
# 成功率应该 > 95%
# 看到大量 "Send C2C Message" 和 "Send Ping Heartbeat"
```

### 服务端监控

```bash
# 1. 查看连接数
docker exec im-connect ss -tn | grep :10001 | grep ESTAB | wc -l

# 2. 查看 CPU 和内存
docker stats im-connect --no-stream

# 3. 查看日志
docker logs -f im-connect | grep -E "连接|断开|异常"

# 4. 查看文件句柄
docker exec im-connect sh -c 'ls -l /proc/$(pidof java)/fd | wc -l'
```

---

## ❓ 常见问题

### Q1: 提示 "打开的文件过多"

**A:** 脚本会自动提升 ulimit，如果失败，手动执行：

```bash
ulimit -n 100000
./run-jar.sh ...
```

### Q2: 大量 "Premature close" 错误

**A:** 可能的原因：
1. 服务端资源不足 → 降低用户数
2. 网络不稳定 → 检查网络
3. 心跳超时 → 已修复，重新编译

### Q3: 连接建立很慢

**A:** 增加启动时间：

```bash
# 10000 用户，用 300 秒启动（原来 120 秒）
./run-jar.sh 192.168.1.150 10001 10000 300 600 5000 30000
```

### Q4: 如何查看报告？

**A:** 报告在服务器上：

```bash
# 服务器上查看路径
ls -lh /home/hzz/压测工具/results/

# 下载到本地查看
scp -r root@your-server:/home/hzz/压测工具/results ./
open results/最新目录/index.html
```

---

## ✅ 成功标准

| 指标 | 100 连接 | 1000 连接 | 10000 连接 |
|------|---------|----------|-----------|
| **成功率** | > 99% | > 95% | > 90% |
| **连接时间** | < 1s | < 5s | < 30s |
| **消息延迟** | < 50ms | < 100ms | < 200ms |
| **无错误** | ✅ | ✅ | ✅ |

---

## 🎯 下一步

1. ✅ 从 100 连接开始测试
2. ✅ 确认成功率 > 95%
3. ✅ 逐步增加到 1000、10000
4. ✅ 记录每次测试结果
5. ✅ 找到服务器瓶颈

---

## 📞 需要帮助？

查看详细指南：`cat STRESS_TEST_GUIDE.md`

Good luck! 🚀
